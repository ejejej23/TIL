### 인덱스 튜닝

### 인덱스 ROWID
- 물리적주소보다 논리적 주소에 가깝다. 
- 포인터가 아님.
- 디스크상에서 테이블 레코드를 찾아가기 위한 정보를 담는다. 
- 테이블 레코드와 물리적으로 연결된 구조가 아니다

## 메인메모리DB
- 데이터를 모두 메모리에 로드해놓고 메모리를 통해서만 IO를 수행하는 DB

## 인덱스 클러스터링 팩터
: 군집성계수. 특정 컬럼을 기준으로 같은 값을 갖는 데이터가 서로 모여있는 정도

효과 : 오라클은 래치획득과 해시 체인 스캔과정을 거쳐 찾은 테이블 를록에 대한 포인터를 바로 해지하지 않고 일단 유지한다. 이것이 버퍼Pinning이다.

이때 다음 레코드를 읽으면서 마침 직전과 같은 테이블 블록을 가리킨다. 이러면 래치획득과 해시체인 스캔과정을 생략하고 바로 테이블 블록을 읽을수 있다. 논리적인 블록 io과정을 생략할 수 있는것.

## 인덱스를 이용한 테이블 액세스가 table full access 보다 느리게 만드는 요인
1. table full scan은 시퀀셜 액세스. 인덱스 rowId를 이용한 테이블 액세스는 랜덤 액세스
2. table full scan은 멀티블록 io, 인덱스 rowId를 이용한 테이블 액세스는 싱글블록 io

-----

# 인덱스 구조 테이블
: 랜덤액세스가 아예 발생하지 않도록 테이블을 인덱스 구조로 생성. 인덱스와 달리 그 자리에 테이블 데이터를 갖는다.
인위적으로 클러스터링 팩터를 좋게 만드는 방식중 하나다.

- 오라클 : IOT(Index-Organized Table).
- MSSQL : 클러스터형 인덱스

cf) 일반테이블은 '힙 구조 테이블'. iot는 '인덱스 구조 테이블'

## 클러스터 테이블
- 인덱스 클러스터
- 해시 클러스터


### 인덱스 클러스터
- 다중 테이블 클러스터 : 여러 테이블 레코드를 같은 블록에 저장할 수도 있다.
- 클러스터에 테이블을 담기 전에 클러스터 인덱스를 반드시 정의해야한다.
- 일반테이블에 생성한 인덱스 레코드는 테이블 레코드와 1:1 대응. 
- 클러스터 인덱스는 테이블 레코드와 1:M 관계. 따라서 클러스터 인덱스의 키 값은 항상 유니크하다.

### 해시 클러스터
- 인덱스를 사용하지 않고 해시알고리즘을 사용해 클러스터를 찾아간다는 점만 다르다.

-----

#부분범위 처리
: 부분범위 처리 = 전체 쿼리 결과집합을 쉼없이 연속적으로 전송하지 않고 사용자로부터 fetch call 이 있을때마다 일정량씩 나누어 전송하는것

1. 최초 rs.next() 호출시 fetch call을 통해 db서버에서 전송받은 데이터 10건을 클라이언트 캐시에 저장
2. 이후 rs.next() 호출시 fetch call을 발생시키지 않고 캐시에서 데이터를 읽음
3. 캐시에 저장한 데이터를 모두 소진한 상태에서 rs.next() 호출시 추가 fetch call 발생
4. 100건을 다 읽을때까지 1~3 반복

------

## 액세스 조건
: 인덱스 스캔 범위를 결정하는 조건

## 필터 조건
: 테이블로 액세스할지를 결정하는 조건절

### 테이블 액세스 단계에서 처리되는 조건절은 모두 필터 조건이다. 테이블 필터 조건은 쿼리 수행 다음단계로 전달하거나 최종 결과집합에 포함할지를 결정한다.

### 인덱스 스캔 효율성은 인덱스 컬럼을 조건절에 모두 등치(=)로 사용할 때 가장 좋다

-----

# 인덱스 설계

## 인덱스가 많으면 생기는 문제
1. DML 성능저하(-> TPS 저하)
2. 데이터베이스 사이즈 증가(-> 디스크 공간 낭비)
3. 데이터베이스 관리 및 운영비용 상승

## 인덱스 설계의 가장 중요한 기준 두가지 for 스캔효율성
1. 조건절에 항상 사용하거나 자주 사용하는 컬럼을 선정
2. = 조건으로 자주 조회하는 컬럼을 앞쪽에 둔다

### 스캔 효율성 외 판단기준
1. 수행빈도
2. 업무상 중요도
3. 클러스터링 팩터
4. 데이터량
5. dml부하
6. 저장공간
7. 인덱스 관리비용 등

### 결론적으로 인덱스 생성여부를 결정할 때는 선택도가 매우 중요하지만 컬럼간 순서를 결정할 때는 각 컬럼의 선택도보다 필수조건여부, 연산자 형태가 더 중요한 판단기준이다. 어느 컬럼을 앞에 두는것이 유리한지는 상황에 달림

